/*! asmsimulator 10-01-2022 */
var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(a){return{go:function(b){for(var c=/^[\t ]*(?:([.A-Z_a-z][A-Z_\(\)\,a-z0-9]*)[:])?(?:[\t ]*([A-Za-z]{2,4})(?:[\t ]+(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*)(?:[\t ]*[,][\t ]*(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*))?)?)?/,d=3,e=7,f=/^[-+]?[0-9]+$/,g=/^[.A-Za-z]\w*$/,h=[],i={},j={},k={},l={},m=b.split("\n"),n=function(a){if("0x"===a.slice(0,2))return parseInt(a.slice(2),16);if("0o"===a.slice(0,2))return parseInt(a.slice(2),8);if("b"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),2);if("d"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),10);if(f.exec(a))return parseInt(a,10);throw"Invalid number format"},o=function(a){return a=a.toUpperCase(),"A"===a?0:"B"===a?1:"C"===a?2:"M"===a?3:"IX"===a?4:"SP"===a?5:void 0},p=function(a){a=a.toUpperCase();var b=0,c=0;if("A"===a[0])c=0;else if("B"===a[0])c=1;else if("C"===a[0])c=2;else if("M"===a[0])c=3;else if("IX"===a[0])c=4;else{if("SP"!==a.slice(0,2))return void 0;c=5}var d=1;if(4===c&&(d=2),"-"===a[d])b=-1;else{if("+"!==a[d])return void 0;b=1}var e=b*parseInt(a.slice(d+1),10);if(-16>e||e>15)throw"offset must be a value between -16...+15";return 0>e&&(e=32+e),8*e+c},q=function(a,b,c){var d=o(a);if(void 0!==d)return{type:b,value:d};var e=r(a);if(void 0!==e)return{type:c,value:e};if("regaddress"===b&&(d=p(a),void 0!==d))return{type:b,value:d};var f=n(a);if(isNaN(f))throw"Not a "+c+": "+f;if(0>f||f>255)throw c+" must have a value between 0-255";return{type:c,value:f}},r=function(a){return g.exec(a)?a:void 0},s=function(a){switch(a.slice(0,1)){case"[":var b=a.slice(1,a.length-1);return q(b,"regaddress","address");case'"':for(var c=a.slice(1,a.length-1),d=[],e=0,f=c.length;f>e;e++)d.push(c.charCodeAt(e));return{type:"numbers",value:d};case"'":var g=a.slice(1,a.length-1);if(g.length>1)throw"Only one character is allowed. Use String instead";return{type:"number",value:g.charCodeAt(0)};default:return q(a,"register","number")}},t=(function(a){var b=a.toUpperCase();if(b in l)throw"Duplicate label: "+a;if("A"===b||"B"===b||"C"===b||"M"===b||"IX"===b)throw"Label contains keyword: "+b;j[a]=h.length%256,k[a]=Math.floor(h.length/256)}),u=function(a,b){if(void 0!==b)throw a+": too many arguments"},v=0,w=m.length;w>v;v++)try{var x=c.exec(m[v]);if(void 0!==x[1]||void 0!==x[2]){if(void 0!==x[1]&&t(x[1]),void 0!==x[2]){var y,z,A=x[2].toUpperCase();switch("DB"!==A&&(i[h.length]=v),A){case"DB":if(y=s(x[d]),"number"===y.type)h.push(y.value);else{if("numbers"!==y.type)throw"DB does not support this operand";for(var B=0,C=y.value.length;C>B;B++)h.push(y.value[B])}break;case"DBB":for(var D=h.length;254>D;D++)51!=D?h.push(0):h.push(80);h.push(254);break;case"GOTO":y=s(x[d]),"number"===y.type&&(h.push(a.LIX),i[h.length]=v+1,h.push(y.value),i[h.length]=v+2,z=a.MMA,h.push(z),i[h.length]=v+3,z=a.JMP,h.push(z));break;case"HLT":u("HLT",x[d]),z=a.HLT,h.push(z);break;case"NOP":u("NOP",x[d]),z=a.NOP,h.push(z);break;case"ADL":u("ADL",x[d]),z=a.ADL,h.push(z);break;case"ADH":u("ADH",x[d]),z=a.ADH,h.push(z);break;case"AND":u("AND",x[d]),z=a.AND,h.push(z);break;case"OR":u("OR",x[d]),z=a.OR,h.push(z);break;case"XOR":u("XOR",x[d]),z=a.XOR,h.push(z);break;case"NOT":u("NOT",x[d]),z=a.NOT,h.push(z);break;case"CLC":u("CLC",x[d]),z=a.CLC,h.push(z);break;case"SEC":u("SEC",x[d]),z=a.SEC,h.push(z);break;case"SHL":u("SHL",x[d]),z=a.SHL,h.push(z);break;case"SHR":u("SHR",x[d]),z=a.SHR,h.push(z);break;case"JMP":u("JMP",x[d]),z=a.JMP,h.push(z);break;case"JNE":u("JNE",x[d]),z=a.JNE,h.push(z);break;case"LDA":u("LDA",x[d]),z=a.LDA,h.push(z);break;case"STA":u("STA",x[d]),z=a.STA,h.push(z);break;case"MAC":u("MAC",x[d]),z=a.MAC,h.push(z);break;case"MBA":u("MBA",x[d]),z=a.MBA,h.push(z);break;case"MAM":u("MAM",x[d]),z=a.MAM,h.push(z);break;case"MMA":u("MMA",x[d]),z=a.MMA,h.push(z);break;case"MPA":u("MAP",x[d]),z=a.MAP,h.push(z);break;case"MGM":u("MGM",x[d]),z=a.MGM,h.push(z);break;case"MLG":u("MLG",x[d]),z=a.MLG,h.push(z);break;case"MGL":u("MGL",x[d]),z=a.MGL,h.push(z);break;case"IXR":u("IXR",x[d]),z=a.IXR,h.push(z);break;case"IXN":u("IXN",x[d]),z=a.IXN,h.push(z);break;case"LIL":if(y=s(x[d]),u("LIL",x[e]),"number"!==y.type)throw A+" does not suppport this operand";switch(y.value){case 0:z=a.LIL_0;break;case 1:z=a.LIL_1;break;case 2:z=a.LIL_2;break;case 3:z=a.LIL_3;break;case 4:z=a.LIL_4;break;case 5:z=a.LIL_5;break;case 6:z=a.LIL_6;break;case 7:z=a.LIL_7;break;case 8:z=a.LIL_8;break;case 9:z=a.LIL_9;break;case 10:z=a.LIL_A;break;case 11:z=a.LIL_B;break;case 12:z=a.LIL_C;break;case 13:z=a.LIL_D;break;case 14:z=a.LIL_E;break;case 15:z=a.LIL_F;break;default:throw"Incorrect value for LIL"}h.push(z);break;case"LIH":if(y=s(x[d]),u("LIH",x[e]),"number"!==y.type)throw A+" does not suppport this operand";switch(y.value){case 0:z=a.LIH_0;break;case 1:z=a.LIH_1;break;case 2:z=a.LIH_2;break;case 3:z=a.LIH_3;break;case 4:z=a.LIH_4;break;case 5:z=a.LIH_5;break;case 6:z=a.LIH_6;break;case 7:z=a.LIH_7;break;case 8:z=a.LIH_8;break;case 9:z=a.LIH_9;break;case 10:z=a.LIH_A;break;case 11:z=a.LIH_B;break;case 12:z=a.LIH_C;break;case 13:z=a.LIH_D;break;case 14:z=a.LIH_E;break;case 15:z=a.LIH_F;break;default:throw"Incorrect value for LIH"}h.push(z);break;case"LIX":y=s(x[d]),u("LIX",x[e]),z=a.LIX,h.push(z),i[h.length]=v+1,h.push(y.value);break;default:throw"Invalid instruction: "+x[2]}}}else{var E=m[v].trim();if(""!==E&&";"!==E.slice(0,1))throw"Syntax error"}}catch(F){throw{error:F,line:v}}var G=!1;for(v=0,w=h.length;w>v;v++)if(!angular.isNumber(h[v])){if(!(h[v]in j))throw{error:"Undefined label: "+h[v]};v-2>=0&&h[v-2]==a.IXN&&(G=!0),v-1>=0&&h[v-1]==a.LIX?G?(h[v-1]=a.LIL_0+(15&k[h[v]]),h[v]=a.LIH_0+(k[h[v]]>>>4)):(h[v-1]=a.LIL_0+(15&j[h[v]]),h[v]=a.LIH_0+(j[h[v]]>>>4)):h[v]=j[h[v]],G=!1}return{code:h,mapping:i,labels:j,labels_ix:k}}}}]),app.service("cpu",["opcodes","memory",function(a,b){var c={step:function(){var c=this;if(c.fault===!0)throw"FAULT. Reset to continue.";try{var d=function(a){if(0>a||a>=1+c.gpr.length)throw"Invalid register: "+a;return a},e=function(a,b){if(a>=0&&a<c.gpr.length)c.gpr[a]=b;else{if(a!=c.gpr.length)throw"Invalid register: "+a;if(c.sp=b,c.sp<c.minSP)throw"Stack overflow";if(c.sp>c.maxSP)throw"Stack underflow"}},f=function(a){if(a>=0&&a<c.gpr.length)return c.gpr[a];if(a==c.gpr.length)return c.sp;throw"Invalid register: "+a},g=function(a){if(0>a-1||a>=b.data.length)throw"IP outside memory";c.pc=a-1};if(c.pc<0||c.pc>=b.data.length)throw"Instruction pointer is outside of memory";var h=b.load(c.pc);switch(h){case a.HLT:return!1;case a.NOP:c.pc++;break;case a.ADL:e(d(2),(240&f(2))+(15&f(0))+(15&f(1))+c.carry&255),(15&f(0))+(15&f(1))+c.carry>15?c.carry=!0:c.carry=!1,c.pc++;break;case a.ADH:e(d(2),(15&f(2))+((240&f(0))+((240&f(1))+(c.carry<<4)))&255),((240&f(0))>>4)+((240&f(1))>>4)+c.carry>15?c.carry=!0:c.carry=!1,c.pc++;break;case a.AND:e(d(2),f(0)&f(1)),c.pc++;break;case a.OR:e(d(2),f(0)|f(1)),c.pc++;break;case a.XOR:e(d(2),f(0)^f(1)),c.pc++;break;case a.NOT:e(d(2),~f(0)>>>0&255),c.pc++;break;case a.CLC:c.carry=!1,c.pc++;break;case a.SEC:c.carry=!0,c.pc++;break;case a.SHL:e(d(2),f(0)<<1&255),c.carry=f(0)>>>7==1?!0:!1,c.pc++;break;case a.SHR:e(d(2),f(0)>>>1),c.carry=f(0)&!0?!0:!1,c.pc++;break;case a.JMP:g(f(3)),c.pc++;break;case a.JNE:0!==f(2)&&g(f(3)),c.pc++;break;case a.LDA:e(d(0),b.load(f(3))),c.pc++;break;case a.STA:b.store(f(3),f(0)),c.pc++;break;case a.MAC:e(d(0),f(2)),c.pc++;break;case a.MBA:e(d(1),f(0)),c.pc++;break;case a.MAM:e(d(0),f(3)),c.pc++;break;case a.MMA:if(0===c.gpr[4])e(d(3),f(3)-(255&f(3))+f(0));else{if(1!==c.gpr[4])throw"Invalid usage of MMA: "+pc;e(d(3),f(3)-(65280&f(3))+(f(0)<<8))}c.pc++;break;case a.MAP:e(d(0),c.pc),c.pc++;break;case a.MGM:c.pc++;break;case a.MLG:c.pc++;break;case a.MGL:c.pc++;break;case a.IXR:e(d(4),0),c.pc++;break;case a.IXN:e(d(4),f(4)+1),c.pc++;break;case a.LIL_0:e(d(0),(240&f(0))+0),c.pc++;break;case a.LIL_1:e(d(0),(240&f(0))+1),c.pc++;break;case a.LIL_2:e(d(0),(240&f(0))+2),c.pc++;break;case a.LIL_3:e(d(0),(240&f(0))+3),c.pc++;break;case a.LIL_4:e(d(0),(240&f(0))+4),c.pc++;break;case a.LIL_5:e(d(0),(240&f(0))+5),c.pc++;break;case a.LIL_6:e(d(0),(240&f(0))+6),c.pc++;break;case a.LIL_7:e(d(0),(240&f(0))+7),c.pc++;break;case a.LIL_8:e(d(0),(240&f(0))+8),c.pc++;break;case a.LIL_9:e(d(0),(240&f(0))+9),c.pc++;break;case a.LIL_A:e(d(0),(240&f(0))+10),c.pc++;break;case a.LIL_B:e(d(0),(240&f(0))+11),c.pc++;break;case a.LIL_C:e(d(0),(240&f(0))+12),c.pc++;break;case a.LIL_D:e(d(0),(240&f(0))+13),c.pc++;break;case a.LIL_E:e(d(0),(240&f(0))+14),c.pc++;break;case a.LIL_F:e(d(0),(240&f(0))+15),c.pc++;break;case a.LIH_0:e(d(0),(15&f(0))+0),c.pc++;break;case a.LIH_1:e(d(0),(15&f(0))+16),c.pc++;break;case a.LIH_2:e(d(0),(15&f(0))+32),c.pc++;break;case a.LIH_3:e(d(0),(15&f(0))+48),c.pc++;break;case a.LIH_4:e(d(0),(15&f(0))+64),c.pc++;break;case a.LIH_5:e(d(0),(15&f(0))+80),c.pc++;break;case a.LIH_6:e(d(0),(15&f(0))+96),c.pc++;break;case a.LIH_7:e(d(0),(15&f(0))+112),c.pc++;break;case a.LIH_8:e(d(0),(15&f(0))+128),c.pc++;break;case a.LIH_9:e(d(0),(15&f(0))+144),c.pc++;break;case a.LIH_A:e(d(0),(15&f(0))+160),c.pc++;break;case a.LIH_B:e(d(0),(15&f(0))+176),c.pc++;break;case a.LIH_C:e(d(0),(15&f(0))+192),c.pc++;break;case a.LIH_D:e(d(0),(15&f(0))+208),c.pc++;break;case a.LIH_E:e(d(0),(15&f(0))+224),c.pc++;break;case a.LIH_F:e(d(0),(15&f(0))+240),c.pc++;break;default:throw"Invalid op code: "+h}return!0}catch(i){throw c.fault=!0,i}},reset:function(){var a=this;a.maxSP=254,a.minSP=0,a.gpr=[0,0,0,0,0],a.sp=a.maxSP,a.pc=0,a.zero=!1,a.carry=!1,a.fault=!1}};return c.reset(),c}]),app.service("global",[function(){var a={data:Array(256),lastAccess:-1,load:function(a){var b=this;if(0>a||a>=b.data.length)throw"Memory access violation at "+a;return b.lastAccess=a,b.data[a]},store:function(a,b){var c=this;if(0>a||a>=c.data.length)throw"Memory access violation at "+a;c.lastAccess=a,c.data[a]=b},reset:function(){var a=this;a.lastAccess=-1;for(var b=0,c=a.data.length;c>b;b++)a.data[b]=0}};return a.reset(),a}]),app.service("memory",[function(){var a={blocks:100,data:Array(25600),lastAccess:-1,load:function(a){var b=this;if(0>a||a>=b.data.length)throw"Memory access violation at "+a;return b.lastAccess=a,b.data[a]},store:function(a,b){var c=this;if(0>a||a>=c.data.length)throw"Memory access violation at "+a;c.lastAccess=a,c.data[a]=b},reset:function(){var a=this;a.lastAccess=-1;for(var b=0,c=a.data.length;c>b;b++)a.data[b]=0}};return a.reset(),a}]),app.service("opcodes",[function(){var a={HLT:0,NOP:1,ADL:5,ADH:7,AND:8,OR:9,XOR:10,NOT:11,CLC:12,SEC:13,SHL:14,SHR:15,JMP:16,JNE:17,LDA:33,STA:34,MAC:35,MBA:36,MAM:37,MMA:38,MAP:39,MGM:40,MLG:41,MGL:42,IXR:43,IXN:44,LIX:63,LIL_0:64,LIL_1:65,LIL_2:66,LIL_3:67,LIL_4:68,LIL_5:69,LIL_6:70,LIL_7:71,LIL_8:72,LIL_9:73,LIL_A:74,LIL_B:75,LIL_C:76,LIL_D:77,LIL_E:78,LIL_F:79,LIH_0:80,LIH_1:81,LIH_2:82,LIH_3:83,LIH_4:84,LIH_5:85,LIH_6:86,LIH_7:87,LIH_8:88,LIH_9:89,LIH_A:90,LIH_B:91,LIH_C:92,LIH_D:93,LIH_E:94,LIH_F:95};return a}]),app.filter("block",function(){return function(a,b){return b=+b,a.slice(256*b,256*b+256)}}),app.controller("Ctrl",["$document","$scope","$timeout","cpu","memory","global","assembler",function(a,b,c,d,e,f,g){b.memory=e,b.global=f,b.cpu=d,b.error="",b.isRunning=!1,b.displayHex=!0,b.displayInstr=!0,b.displayA=!1,b.displayB=!1,b.displayC=!1,b.displayM=!0,b.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"},{speed:32,desc:"32 HZ"},{speed:64,desc:"64 HZ"},{speed:128,desc:"128 HZ"},{speed:256,desc:"256 HZ"}],b.speed=16,b.outputStartIndex=25576,b.memoryBlockLength=256,b.code='GOTO start\n\nDB "Hello World!"\nDB 0\n\nstart:\nLIL 0x0\nLIH 0x0\nMBA\n\nLIL 0x7\nLIH 0xE\nMMA\nSTA\n\nLIL 0x6\nLIH 0xE\nMMA\nLIL 0x4\nLIH 0x0\nSTA\n\nloop:\nLIL 0x7\nLIH 0xE\nMMA\nLDA\nSEC\nADL\nADH\nMAC\nSTA\n\nLIL 0x6\nLIH 0xE\nMMA\nLDA\nMMA\nLDA\nCLC\nADL\nADH\nLIL 0x7\nLIH 0xE\nMMA\nLDA\nMMA\nMAC\nSTA\n\nLIL 0x6\nLIH 0xE\nMMA\nLDA\nSEC\nADL\nADH\nMAC\nSTA\n\nMMA\nLDA\nCLC\nADL\nADH\n\nLIX loop\nMMA\nJNE\n\nHLT',b.reset=function(){d.reset(),e.reset(),b.error="",b.selectedLine=-1},b.executeStep=function(){b.checkPrgrmLoaded()||b.assemble();try{var a=d.step();return d.ip in b.mapping&&(b.selectedLine=b.mapping[d.ip]),a}catch(c){return b.error=c,!1}};var h;b.run=function(){b.checkPrgrmLoaded()||b.assemble(),b.isRunning=!0,h=c(function(){b.executeStep()===!0?b.run():b.isRunning=!1},1e3/b.speed)},b.stop=function(){c.cancel(h),b.isRunning=!1},b.checkPrgrmLoaded=function(){for(var a=0,b=e.data.length;b>a;a++)if(0!==e.data[a])return!0;return!1},b.getChar=function(a){var b=String.fromCharCode(a);return""===b.trim()?"  ":b},b.assemble=function(){try{b.reset();var a=g.go(b.code);b.mapping=a.mapping;var c=a.code;if(b.labels=a.labels,b.labels_ix=a.labels_ix,c.length>e.data.length)throw"Binary code does not fit into the memory. Max "+e.data.length+" bytes are allowed";for(var d=0,f=c.length;f>d;d++)e.data[d]=c[d]}catch(h){void 0!==h.line?(b.error=h.line+" | "+h.error,b.selectedLine=h.line):b.error=h.error}},b.jumpToLine=function(c){a[0].getElementById("sourceCode").scrollIntoView(),b.selectedLine=b.mapping[c]},b.isInstruction=function(a){return void 0!==b.mapping&&void 0!==b.mapping[a]&&b.displayInstr},b.getMemoryCellCss=function(a){return a>=b.outputStartIndex?"output-bg":b.isInstruction(a)?"instr-bg":a>d.sp&&a<=d.maxSP?"stack-bg":""},b.getMemoryInnerCellCss=function(a){return a===d.pc?"marker marker-pc":a===d.sp?"marker marker-sp":a===d.gpr[0]&&b.displayA?"marker marker-a":a===d.gpr[1]&&b.displayB?"marker marker-b":a===d.gpr[2]&&b.displayC?"marker marker-c":a===d.gpr[3]&&b.displayM?"marker marker-m":""}}]),app.filter("flag",function(){return function(a){return a.toString().toUpperCase()}}),app.filter("number",function(){return function(a,b){if(b){var c=a.toString(16).toUpperCase();return 1==c.length?"0"+c:c}return a.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(a,b,c,d){a.$watch("selectedLine",function(){if(a.selectedLine>=0){for(var c=b[0].value.split("\n"),d=0,e=0;e<c.length&&e!=a.selectedLine;e++)d+=c[e].length+1;var f=c[a.selectedLine].length+d;if("undefined"!=typeof b[0].selectionStart&&(b[0].focus(),b[0].selectionStart=d,b[0].selectionEnd=f),document.selection&&document.selection.createRange){b[0].focus(),b[0].select();var g=document.selection.createRange();g.collapse(!0),g.moveEnd("character",f),g.moveStart("character",d),g.select()}}})}}}]),app.filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(a,b,c,d){b.bind("keydown",function(a){if(9===a.keyCode){var b=this.value,c=this.selectionStart,d=this.selectionEnd;return this.value=b.substring(0,c)+"	"+b.substring(d),this.selectionStart=this.selectionEnd=c+1,a.preventDefault(),!1}})}}}]);