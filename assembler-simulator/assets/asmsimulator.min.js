/*! asmsimulator 01-12-2021 */
var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(a){return{go:function(b){for(var c=/^[\t ]*(?:([.A-Za-z]\w*)[:])?(?:[\t ]*([A-Za-z]{2,4})(?:[\t ]+(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*)(?:[\t ]*[,][\t ]*(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*))?)?)?/,d=3,e=7,f=/^[-+]?[0-9]+$/,g=/^[.A-Za-z]\w*$/,h=[],i={},j={},k={},l=b.split("\n"),m=function(a){if("0x"===a.slice(0,2))return parseInt(a.slice(2),16);if("0o"===a.slice(0,2))return parseInt(a.slice(2),8);if("b"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),2);if("d"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),10);if(f.exec(a))return parseInt(a,10);throw"Invalid number format"},n=function(a){return a=a.toUpperCase(),"A"===a?0:"B"===a?1:"C"===a?2:"M"===a?3:"SP"===a?4:void 0},o=function(a){a=a.toUpperCase();var b=0,c=0;if("A"===a[0])c=0;else if("B"===a[0])c=1;else if("C"===a[0])c=2;else if("M"===a[0])c=3;else{if("SP"!==a.slice(0,2))return void 0;c=4}var d=1;if(4===c&&(d=2),"-"===a[d])b=-1;else{if("+"!==a[d])return void 0;b=1}var e=b*parseInt(a.slice(d+1),10);if(-16>e||e>15)throw"offset must be a value between -16...+15";return 0>e&&(e=32+e),8*e+c},p=function(a,b,c){var d=n(a);if(void 0!==d)return{type:b,value:d};var e=q(a);if(void 0!==e)return{type:c,value:e};if("regaddress"===b&&(d=o(a),void 0!==d))return{type:b,value:d};var f=m(a);if(isNaN(f))throw"Not a "+c+": "+f;if(0>f||f>255)throw c+" must have a value between 0-255";return{type:c,value:f}},q=function(a){return g.exec(a)?a:void 0},r=function(a){switch(a.slice(0,1)){case"[":var b=a.slice(1,a.length-1);return p(b,"regaddress","address");case'"':for(var c=a.slice(1,a.length-1),d=[],e=0,f=c.length;f>e;e++)d.push(c.charCodeAt(e));return{type:"numbers",value:d};case"'":var g=a.slice(1,a.length-1);if(g.length>1)throw"Only one character is allowed. Use String instead";return{type:"number",value:g.charCodeAt(0)};default:return p(a,"register","number")}},s=(function(a){var b=a.toUpperCase();if(b in k)throw"Duplicate label: "+a;if("A"===b||"B"===b||"C"===b||"M"===b)throw"Label contains keyword: "+b;j[a]=h.length}),t=function(a,b){if(void 0!==b)throw a+": too many arguments"},u=0,v=l.length;v>u;u++)try{var w=c.exec(l[u]);if(void 0!==w[1]||void 0!==w[2]){if(void 0!==w[1]&&s(w[1]),void 0!==w[2]){var x,y,z=w[2].toUpperCase();switch("DB"!==z&&(i[h.length]=u),z){case"DB":if(x=r(w[d]),"number"===x.type)h.push(x.value);else{if("numbers"!==x.type)throw"DB does not support this operand";for(var A=0,B=x.value.length;B>A;A++)h.push(x.value[A])}break;case"GOTO":x=r(w[d]),"number"===x.type&&(h.push(a.LIX),i[h.length]=u+1,h.push(x.value),i[h.length]=u+2,y=a.MMA,h.push(y),i[h.length]=u+3,y=a.JMP,h.push(y));break;case"HLT":t("HLT",w[d]),y=a.HLT,h.push(y);break;case"NOP":t("NOP",w[d]),y=a.NOP,h.push(y);break;case"ADL":t("ADL",w[d]),y=a.ADL,h.push(y);break;case"ADH":t("ADH",w[d]),y=a.ADH,h.push(y);break;case"AND":t("AND",w[d]),y=a.AND,h.push(y);break;case"OR":t("OR",w[d]),y=a.OR,h.push(y);break;case"XOR":t("XOR",w[d]),y=a.XOR,h.push(y);break;case"NOT":t("NOT",w[d]),y=a.NOT,h.push(y);break;case"CLC":t("CLC",w[d]),y=a.CLC,h.push(y);break;case"SEC":t("SEC",w[d]),y=a.SEC,h.push(y);break;case"SHL":t("SHL",w[d]),y=a.SHL,h.push(y);break;case"SHR":t("SHR",w[d]),y=a.SHR,h.push(y);break;case"JMP":t("JMP",w[d]),y=a.JMP,h.push(y);break;case"JNE":t("JNE",w[d]),y=a.JNE,h.push(y);break;case"LDA":t("LDA",w[d]),y=a.LDA,h.push(y);break;case"STA":t("STA",w[d]),y=a.STA,h.push(y);break;case"MAC":t("MAC",w[d]),y=a.MAC,h.push(y);break;case"MBA":t("MBA",w[d]),y=a.MBA,h.push(y);break;case"MAM":t("MAM",w[d]),y=a.MAM,h.push(y);break;case"MMA":t("MMA",w[d]),y=a.MMA,h.push(y);break;case"MPA":t("MAP",w[d]),y=a.MAP,h.push(y);break;case"MGM":t("MGM",w[d]),y=a.MGM,h.push(y);break;case"MLG":t("MLG",w[d]),y=a.MLG,h.push(y);break;case"MGL":t("MGL",w[d]),y=a.MGL,h.push(y);break;case"IXR":t("IXR",w[d]),y=a.IXR,h.push(y);break;case"IXN":t("IXN",w[d]),y=a.IXN,h.push(y);break;case"LIL":if(x=r(w[d]),t("LIL",w[e]),"number"!==x.type)throw z+" does not suppport this operand";switch(x.value){case 0:y=a.LIL_0;break;case 1:y=a.LIL_1;break;case 2:y=a.LIL_2;break;case 3:y=a.LIL_3;break;case 4:y=a.LIL_4;break;case 5:y=a.LIL_5;break;case 6:y=a.LIL_6;break;case 7:y=a.LIL_7;break;case 8:y=a.LIL_8;break;case 9:y=a.LIL_9;break;case 10:y=a.LIL_A;break;case 11:y=a.LIL_B;break;case 12:y=a.LIL_C;break;case 13:y=a.LIL_D;break;case 14:y=a.LIL_E;break;case 15:y=a.LIL_F;break;default:throw"Incorrect value for LIL"}h.push(y);break;case"LIH":if(x=r(w[d]),t("LIH",w[e]),"number"!==x.type)throw z+" does not suppport this operand";switch(x.value){case 0:y=a.LIH_0;break;case 1:y=a.LIH_1;break;case 2:y=a.LIH_2;break;case 3:y=a.LIH_3;break;case 4:y=a.LIH_4;break;case 5:y=a.LIH_5;break;case 6:y=a.LIH_6;break;case 7:y=a.LIH_7;break;case 8:y=a.LIH_8;break;case 9:y=a.LIH_9;break;case 10:y=a.LIH_A;break;case 11:y=a.LIH_B;break;case 12:y=a.LIH_C;break;case 13:y=a.LIH_D;break;case 14:y=a.LIH_E;break;case 15:y=a.LIH_F;break;default:throw"Incorrect value for LIH"}h.push(y);break;case"LIX":x=r(w[d]),t("LIX",w[e]),y=a.LIX,h.push(y),i[h.length]=u+1,h.push(x.value);break;default:throw"Invalid instruction: "+w[2]}}}else{var C=l[u].trim();if(""!==C&&";"!==C.slice(0,1))throw"Syntax error"}}catch(D){throw{error:D,line:u}}for(u=0,v=h.length;v>u;u++)if(!angular.isNumber(h[u])){if(!(h[u]in j))throw{error:"Undefined label: "+h[u]};u-1>=0&&h[u-1]==a.LIX?(h[u-1]=a.LIL_0+(15&j[h[u]]),h[u]=a.LIH_0+(j[h[u]]>>>4)):h[u]=j[h[u]]}return{code:h,mapping:i,labels:j}}}}]),app.service("cpu",["opcodes","memory",function(a,b){var c={step:function(){var c=this;if(c.fault===!0)throw"FAULT. Reset to continue.";try{var d=function(a){if(0>a||a>=1+c.gpr.length)throw"Invalid register: "+a;return a},e=function(a,b){if(a>=0&&a<c.gpr.length)c.gpr[a]=b;else{if(a!=c.gpr.length)throw"Invalid register: "+a;if(c.sp=b,c.sp<c.minSP)throw"Stack overflow";if(c.sp>c.maxSP)throw"Stack underflow"}},f=function(a){if(a>=0&&a<c.gpr.length)return c.gpr[a];if(a==c.gpr.length)return c.sp;throw"Invalid register: "+a},g=function(a){return c.zero=!1,c.carry=!1,a>=256?(c.carry=!0,a%=256):0===a?c.zero=!0:0>a&&(c.carry=!0,a=256- -a%256),a},h=function(a){if(0>a-1||a>=b.data.length)throw"IP outside memory";c.pc=a-1};if(c.pc<0||c.pc>=b.data.length)throw"Instruction pointer is outside of memory";var i=b.load(c.pc);switch(i){case a.HLT:return!1;case a.NOP:c.pc++;break;case a.ADL:e(d(2),(240&f(2))+(15&f(0))+(15&f(1))+c.carry&255),(15&f(0))+(15&f(1))+c.carry>15?c.carry=!0:c.carry=!1,c.pc++;break;case a.ADH:e(d(2),(15&f(2))+((240&f(0))+((240&f(1))+(c.carry<<4)))&255),((240&f(0))>>4)+((240&f(1))>>4)+c.carry>15?c.carry=!0:c.carry=!1,c.pc++;break;case a.AND:e(d(2),f(0)&f(1)),c.pc++;break;case a.OR:e(d(2),f(0)|f(1)),c.pc++;break;case a.XOR:e(d(2),f(0)^f(1)),c.pc++;break;case a.NOT:e(d(2),~f(0)>>>0&255),c.pc++;break;case a.CLC:c.carry=!1,c.pc++;break;case a.SEC:c.carry=!0,c.pc++;break;case a.SHL:e(d(2),f(0)<<1&255),c.carry=f(0)>>>7==1?!0:!1,c.pc++;break;case a.SHR:e(d(2),f(0)>>>1),c.carry=f(0)&!0?!0:!1,c.pc++;break;case a.JMP:h(f(3)),c.pc++;break;case a.JNE:0!==f(2)&&h(f(3)),c.pc++;break;case a.LDA:e(d(0),b.load(f(3))),c.pc++;break;case a.STA:b.store(f(3),f(0)),c.pc++;break;case a.MAC:e(d(0),f(2)),c.pc++;break;case a.MBA:e(d(1),f(0)),c.pc++;break;case a.MAM:e(d(0),f(3)),c.pc++;break;case a.MMA:e(d(3),f(0)),c.pc++;break;case a.MAP:e(d(0),c.pc),c.pc++;break;case a.MGM:c.pc++;break;case a.MLG:c.pc++;break;case a.MGL:c.pc++;break;case a.IXR:c.pc++;break;case a.IXN:c.pc++;break;case a.LIL_0:e(d(0),(240&f(0))+0),c.pc++;break;case a.LIL_1:e(d(0),g((240&f(0))+1)),c.pc++;break;case a.LIL_2:e(d(0),g((240&f(0))+2)),c.pc++;break;case a.LIL_3:e(d(0),g((240&f(0))+3)),c.pc++;break;case a.LIL_4:e(d(0),g((240&f(0))+4)),c.pc++;break;case a.LIL_5:e(d(0),g((240&f(0))+5)),c.pc++;break;case a.LIL_6:e(d(0),g((240&f(0))+6)),c.pc++;break;case a.LIL_7:e(d(0),g((240&f(0))+7)),c.pc++;break;case a.LIL_8:e(d(0),g((240&f(0))+8)),c.pc++;break;case a.LIL_9:e(d(0),g((240&f(0))+9)),c.pc++;break;case a.LIL_A:e(d(0),g((240&f(0))+10)),c.pc++;break;case a.LIL_B:e(d(0),g((240&f(0))+11)),c.pc++;break;case a.LIL_C:e(d(0),g((240&f(0))+12)),c.pc++;break;case a.LIL_D:e(d(0),g((240&f(0))+13)),c.pc++;break;case a.LIL_E:e(d(0),g((240&f(0))+14)),c.pc++;break;case a.LIL_F:e(d(0),g((240&f(0))+15)),c.pc++;break;case a.LIH_0:e(d(0),(15&f(0))+0),c.pc++;break;case a.LIH_1:e(d(0),g((15&f(0))+16)),c.pc++;break;case a.LIH_2:e(d(0),g((15&f(0))+32)),c.pc++;break;case a.LIH_3:e(d(0),g((15&f(0))+48)),c.pc++;break;case a.LIH_4:e(d(0),g((15&f(0))+64)),c.pc++;break;case a.LIH_5:e(d(0),g((15&f(0))+80)),c.pc++;break;case a.LIH_6:e(d(0),g((15&f(0))+96)),c.pc++;break;case a.LIH_7:e(d(0),g((15&f(0))+112)),c.pc++;break;case a.LIH_8:e(d(0),g((15&f(0))+128)),c.pc++;break;case a.LIH_9:e(d(0),g((15&f(0))+144)),c.pc++;break;case a.LIH_A:e(d(0),g((15&f(0))+160)),c.pc++;break;case a.LIH_B:e(d(0),g((15&f(0))+176)),c.pc++;break;case a.LIH_C:e(d(0),g((15&f(0))+192)),c.pc++;break;case a.LIH_D:e(d(0),g((15&f(0))+208)),c.pc++;break;case a.LIH_E:e(d(0),g((15&f(0))+224)),c.pc++;break;case a.LIH_F:e(d(0),g((15&f(0))+240)),c.pc++;break;default:throw"Invalid op code: "+i}return!0}catch(j){throw c.fault=!0,j}},reset:function(){var a=this;a.maxSP=231,a.minSP=0,a.gpr=[0,0,0,0],a.sp=a.maxSP,a.pc=0,a.zero=!1,a.carry=!1,a.fault=!1}};return c.reset(),c}]),app.service("memory",[function(){var a={data:Array(256),lastAccess:-1,load:function(a){var b=this;if(0>a||a>=b.data.length)throw"Memory access violation at "+a;return b.lastAccess=a,b.data[a]},store:function(a,b){var c=this;if(0>a||a>=c.data.length)throw"Memory access violation at "+a;c.lastAccess=a,c.data[a]=b},reset:function(){var a=this;a.lastAccess=-1;for(var b=0,c=a.data.length;c>b;b++)a.data[b]=0}};return a.reset(),a}]),app.service("opcodes",[function(){var a={HLT:0,NOP:1,ADL:5,ADH:7,AND:8,OR:9,XOR:10,NOT:11,CLC:12,SEC:13,SHL:14,SHR:15,JMP:16,JNE:17,LDA:33,STA:34,MAC:35,MBA:36,MAM:37,MMA:38,MAP:39,MGM:40,MLG:41,MGL:42,IXR:43,IXN:44,LIX:63,LIL_0:64,LIL_1:65,LIL_2:66,LIL_3:67,LIL_4:68,LIL_5:69,LIL_6:70,LIL_7:71,LIL_8:72,LIL_9:73,LIL_A:74,LIL_B:75,LIL_C:76,LIL_D:77,LIL_E:78,LIL_F:79,LIH_0:80,LIH_1:81,LIH_2:82,LIH_3:83,LIH_4:84,LIH_5:85,LIH_6:86,LIH_7:87,LIH_8:88,LIH_9:89,LIH_A:90,LIH_B:91,LIH_C:92,LIH_D:93,LIH_E:94,LIH_F:95};return a}]),app.controller("Ctrl",["$document","$scope","$timeout","cpu","memory","assembler",function(a,b,c,d,e,f){b.memory=e,b.cpu=d,b.error="",b.isRunning=!1,b.displayHex=!0,b.displayInstr=!0,b.displayA=!1,b.displayB=!1,b.displayC=!1,b.displayM=!1,b.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"}],b.speed=4,b.outputStartIndex=232,b.code='GOTO start\n\nDB "Hello World!"\nDB 0\n\nstart:\nLIL 0x0\nLIH 0x0\nMBA\n\nLIL 0x7\nLIH 0xE\nMMA\nSTA\n\nLIL 0x6\nLIH 0xE\nMMA\nLIL 0x4\nLIH 0x0\nSTA\n\nloop:\nLIL 0x7\nLIH 0xE\nMMA\nLDA\nSEC\nADL\nADH\nMAC\nSTA\n\nLIL 0x6\nLIH 0xE\nMMA\nLDA\nMMA\nLDA\nCLC\nADL\nADH\nLIL 0x7\nLIH 0xE\nMMA\nLDA\nMMA\nMAC\nSTA\n\nLIL 0x6\nLIH 0xE\nMMA\nLDA\nSEC\nADL\nADH\nMAC\nSTA\n\nMMA\nLDA\nCLC\nADL\nADH\n\nLIX loop\nMMA\nJNE\n\nHLT',b.reset=function(){d.reset(),e.reset(),b.error="",b.selectedLine=-1},b.executeStep=function(){b.checkPrgrmLoaded()||b.assemble();try{var a=d.step();return d.ip in b.mapping&&(b.selectedLine=b.mapping[d.ip]),a}catch(c){return b.error=c,!1}};var g;b.run=function(){b.checkPrgrmLoaded()||b.assemble(),b.isRunning=!0,g=c(function(){b.executeStep()===!0?b.run():b.isRunning=!1},1e3/b.speed)},b.stop=function(){c.cancel(g),b.isRunning=!1},b.checkPrgrmLoaded=function(){for(var a=0,b=e.data.length;b>a;a++)if(0!==e.data[a])return!0;return!1},b.getChar=function(a){var b=String.fromCharCode(a);return""===b.trim()?"  ":b},b.assemble=function(){try{b.reset();var a=f.go(b.code);b.mapping=a.mapping;var c=a.code;if(b.labels=a.labels,c.length>e.data.length)throw"Binary code does not fit into the memory. Max "+e.data.length+" bytes are allowed";for(var d=0,g=c.length;g>d;d++)e.data[d]=c[d]}catch(h){void 0!==h.line?(b.error=h.line+" | "+h.error,b.selectedLine=h.line):b.error=h.error}},b.jumpToLine=function(c){a[0].getElementById("sourceCode").scrollIntoView(),b.selectedLine=b.mapping[c]},b.isInstruction=function(a){return void 0!==b.mapping&&void 0!==b.mapping[a]&&b.displayInstr},b.getMemoryCellCss=function(a){return a>=b.outputStartIndex?"output-bg":b.isInstruction(a)?"instr-bg":a>d.sp&&a<=d.maxSP?"stack-bg":""},b.getMemoryInnerCellCss=function(a){return a===d.pc?"marker marker-pc":a===d.sp?"marker marker-sp":a===d.gpr[0]&&b.displayA?"marker marker-a":a===d.gpr[1]&&b.displayB?"marker marker-b":a===d.gpr[2]&&b.displayC?"marker marker-c":a===d.gpr[3]&&b.displayM?"marker marker-m":""}}]),app.filter("flag",function(){return function(a){return a.toString().toUpperCase()}}),app.filter("number",function(){return function(a,b){if(b){var c=a.toString(16).toUpperCase();return 1==c.length?"0"+c:c}return a.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(a,b,c,d){a.$watch("selectedLine",function(){if(a.selectedLine>=0){for(var c=b[0].value.split("\n"),d=0,e=0;e<c.length&&e!=a.selectedLine;e++)d+=c[e].length+1;var f=c[a.selectedLine].length+d;if("undefined"!=typeof b[0].selectionStart&&(b[0].focus(),b[0].selectionStart=d,b[0].selectionEnd=f),document.selection&&document.selection.createRange){b[0].focus(),b[0].select();var g=document.selection.createRange();g.collapse(!0),g.moveEnd("character",f),g.moveStart("character",d),g.select()}}})}}}]),app.filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(a,b,c,d){b.bind("keydown",function(a){if(9===a.keyCode){var b=this.value,c=this.selectionStart,d=this.selectionEnd;return this.value=b.substring(0,c)+"	"+b.substring(d),this.selectionStart=this.selectionEnd=c+1,a.preventDefault(),!1}})}}}]);